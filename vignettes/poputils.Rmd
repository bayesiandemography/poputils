---
title: "poputils"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{poputils}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(poputils)
```


# Aims

Anyone who analyzes demographic data finds themselves doing the same tasks repeatedly: interpreting age labels, calculating life expectancies, rearranging events and exposures data into a common format, and so on. **poputils** contains a small, but growing, set of tools for carrying out these common tasks.

The design principles of **poputils** are:

- Fit in to [tidyverse](https://www.tidyverse.org) workflows. For instance, use data frames for inputs and outputs, use [tidyselect](https://tidyselect.r-lib.org/reference/language.html) methods to specify variables, and follow tidyverse conventions for variable names.
- Use [rvecs](https://bayesiandemography.github.io/rvec/reference/rvec.html) to represent uncertainty. An rvec is a random vector holding multiple draws that behaves similarly to an ordinary R vector.
- Use a common set of methods for handling age and time labels.

Some functions in **poputils** are aimed directly at data analysts working on demographic datasets. Others are aimed at programmers creating functions to be used at data analysts.


# Functions for data analysts

## Labels

### Age

Producers of demographic data follow a wide variety of styles for labeling age groups. **poputils** contains tools for parsing and manipulating age group labels. 

Age label functions in **poputils** require that age labels belong to one of three types:

- `"single"`. Single years of age, possibly including an open age group, eg `"0", `"81"`, `"17"`, `"100+"`. 
- `"five"`. Five-year age groups, possibly including an open age group, eg `"0-4"`, `"80-84"`, `"15-19"`, `"100+"`.
- `"lt"`. Life table age groups. Like `"five"`, but with the `"0-4"` age group split into `"0"` and `"1-4"`.

(More types may be added in future.) Age labels created within **poputils** (eg by function `age_labels()`) follow a standard set of rules, by **poputils** functions can parse labels constructed using other rules,

```{r}
library(poputils)
library(dplyr, warn.conflicts = FALSE)
tibble(x = c("5 to 9", "5_9", "05-09"),
       reformated_x = reformat_age(x))
```

Functions `age_lower()`, `age_upper()`, and  `age_mid()` extract information about the limits and centers of age groups than can be useful for ordering data
```{r}
df <- data.frame(age = c("5-9", "0-4", "15-19", "10-14"),
                 population = c(3, 7, 2, 4))
df
df %>%
  arrange(age_lower(age))
```

and plotting

```{r}
library(ggplot2)
ggplot(df, aes(x = age_mid(age), y = population)) +
  geom_point()
```

among other things.

Functions `combine_age()` and `set_age_open()` can be used to collapse age groups,
```{r}
tibble(age = age_labels("lt", max = 30),
       age_5 = combine_age(age, to = "five"),
       age_25plus = set_age_open(age, lower = 20))
```


### Sex/gender

Function `reformat_sex()` converts categories in a binary sex/gender variable to `"Female"` and `"Male"`. Once conventions emerge for the labeling of additional sex/gender categories, additional options will be added to the function.

## Life tables and life expectancy

A life table a way of summarizing mortality conditions through quantities calculated from age-specific mortality rates. Life expectancy is the best-known of the life table quantities. 

### Basic functionality

Life tables can be calculated from age-specific mortality rates using function `lifetab()`. 

```{r}
nzmort %>%
  filter(year == 2022,
         gender == "Female") %>%
  lifetab()  
```

Function `lifeexp()` focuses in on life expectancy at birth

```{r}
nzmort %>%
  filter(year == 2022,
         gender == "Female") %>%
  lifeexp()  
```

`lifetab()` and `lifeexp()` both have `by` arguments, which can be used to obtain separate results for subpopulations,
```{r}
nzmort %>%
  lifeexp(by = c(gender, year))  
```

The same effect can be obtained using `dplyr::group_by()`,
```{r}
nzmort %>%
  group_by(gender, year) %>%
  lifeexp()
```



### Calculation methods

Demographers have developed many methods for converting mortality rates into life table quantities. The main challenge is capturing changes in mortality rates within each age interval. Correctly representing these changes can be particularly important in the infant ("0") and child ("1-4") age groups, where internal differences can be pronounced. Results are also sensitive to the choice of method when mortality rates are high, and when 5-year, rather than 1-year, age intervals are used.

It turns out that, for the purposes of constructing life tables, all relevant information about changes within an age interval can be captured by a single number: the average length of time lived during that interval by people who die in the interval (Preston et al 2001: 43). This number is denoted $_na_x$, where $x$ is exact age at the start of the internal, and $n$ is the length of the interval. For instance, $_5a20$ refers to the average number of years lived between their 20th and 25th birthdays by people who die between their 20th and 25th birthdays.

In functions `lifetab()` and `lifeexp()`, calculation methods are specified through four arguments: 

- `infant`, which specifies how $a_0$ is calculated (note that, in demographic notation, when $n = 1$ the $n$ subscript is typically omitted),
- `child`, which specifies how $_4a_1$ is calculated,
- `closed`, which specifies how all other closed intervals (ie $a_x$ and $_5a_x$) are calculated, and 
- `open`, which specifies how the final interval, $_{\infty}a_x$ is calculated.

Different choices of method are available for each argument. In some cases, different formulas are used for females and males. The choices and formulas are as follows:

| `argument` | `method`         | `sex`      |                                                                                                                                                           |
| :------- | :------------- | :------- | :------------------------                                                                                                                                        |
| `infant` | `"constant"`   | \<any\>    | $$a_0 = \frac{1 - (m_0 + 1) e^{-m_0}}{m_0 (1 - e^{-m_0})}$$                                                                        |
| `infant` | `"linear"`     | \<any\>    | $$a_0 = 0.5$$                                                                                                                                                      |
| `infant` | `"CD"`         | Female   | $$a_0 = \begin{cases} 0.053 + 2.8 m_0 & 0 \le m_0 < 0.107 \\ 0.35 &  m_0 \ge 0.107 \end{cases}$$                                                                   |
| `infant` | `"CD"`         | Male     | $$a_0 = \begin{cases} 0.045 + 2.684 m_0 & 0 \le m_0 < 0.107 \\ 0.33 &  m_0 \ge 0.107 \end{cases}$$                                                                 |
| `infant` | `"HMD"`        | Female   | $$a_0 = \begin{cases} 0.14903 - 2.05527 m_0 & 0 \le m_0 < 0.01724 \\ 0.04667 + 3.88089 m_0 & 0.01724 \le m_0 < 0.06891 \\ 0.31411 &  m_0 \ge 0.06891 \end{cases}$$ |
| `infant` | `"HMD"`        | Male     | $$a_0 = \begin{cases} 0.14929 - 1.99545 m_0 & 0 \le m_0 <  0.023 \\ 0.02832 + 3.26021 m_0 &  0.023 \le m_0 < 0.08307 \\ 0.29915 &  m_0 \ge 0.08307 \end{cases}$$   |
| `child`  | `"constant"`   | \<any\>    | $$_4a_1 = \frac{1 - (4 \times {_4}m_1 + 1) e^{-4 \times {_4}m_1}}{_4m_1 (1 - e^{-4 \times {_4}m_1})}$$                                                                      |
| `child`  | `"linear"`     | \<any\>    | $$_4a_1 = 2$$                                                                                                                                                      |
| `child`  | `"CD"`         | Female   | $$_4a_1 = \begin{cases} 1.522 - 1.518 m_0 & 0 \le m_0 < 0.107 \\ 1.361 &  m_0 \ge 0.107 \end{cases}$$                                                              |
| `child`  | `"CD"`         | Male     | $$_4a_1 = \begin{cases} 1.651 - 2.816 m_0 & 0 \le m_0 < 0.107 \\ 1.352 &  m_0 \ge 0.107 \end{cases}$$                                                              |
| `closed`   | `"constant"`   | \<any\>    | $$_na_x = \frac{1 - (n \times {_n}m_x + 1) e^{-n \times {_n}m_x}}{_nm_x (1 - e^{-n \times {_n}m_x})}$$ |
| `closed`   | `"linear"`     | \<any\>    | $$_na_x = 0.5 n$$                                                                                                                                                  |
| `open`     | `"constant"`   | \<any\>    | $$_{\infty}a_{\omega} = \frac{l_{\omega}}{_{\infty}m_{\omega}}$$                                                                                                                                |

Once the $_na_x$ have been determined, deriving the remaining life table quantities is straightforward. The probability of dying within each interval, $_nq_x$, is

$$_nq_x = \frac{n \times {_n}m_x}{1 + (n -  {_n}a_x) \times {_nm_x}}$$
with $_{\infty}q_{\omega} = 1$. Quantity $l_x$ is the number of people surviving to exact age $x$. In `lifetab()`, by default, $l_0 = 100,000$. Remaining values are calculated using 

$$l_{x+n} = (1 - {_nq_x}) \times l_x$$
Quantity $_nd_x$ is the number of people who die between exact ages $x$ and $x+n$,

$$_nd_x = l_x - l_{x+n}$$

Quantity $_nL_x$ is the number of person years lived between exact ages $x$ and $x+n$, which equals the number of person-years lived by people who survive the interval, plus the number of person-years lived by people who die within the interval,

$$_nL_x = l_{x+n} \times n + {_nd_x} \times {_na_x}$$
Finally $e_x$, the expected number of years of life remaining to a person aged exactly $x$, is 
$$e_x = {_nL_x} + {_nL_{x+n}} \cdots + {_{\infty}L_{\omega}}$$.

Alternative choices for `infant`, `child`, or `closed` yield different results, though the differences are often small,
```{r}
lin <- nzmort %>%
  lifeexp(by = c(gender, year),
          infant = "linear",
          prefix = "lin")
hmd <- nzmort %>%
  lifeexp(sex = gender,
          by = year,
          infant = "HMD", 
          prefix = "hmd")
left_join(lin, hmd, by = c("year", "gender"))
```
(When `infant` is `"CD"` or `"HMD"`, `lifetab()` and `lifeexp()` require that a `sex` variable be supplied. `lifetab()` and `lifeexp()` automatically include this variable among the `by` variables.)

### Uncertainty

```{r}
library(rvec)
nzmort_rvec
```



```{r}
library(rvec)
nzmort_rvec %>%
  filter(year == 2022,
         gender == "Female") %>%
  lifetab() %>%
  select(age, qx, lx)
```


# Functions for developers

## Labels



## Data manipulation

# Future developments

## Definite
- Forecasting
- Stable popn
- Time labels
- Multiple decrement lifetable/lifeexp

## Possible
- Aggregation??
- 
